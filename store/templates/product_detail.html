{% extends 'base.html' %}
{% block title %}{{ product.title }}{% endblock %}

{% block content %}
<div class="md:flex gap-10">

  <!-- –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ -->
  <div class="md:w-1/2">
    <img src="{{ product.image.url|default:'https://via.placeholder.com/600x600?text=No+Image' }}"
         alt="{{ product.title }}"
         id="product-image"
         class="w-[600px] h-[600px] object-cover rounded-lg shadow-lg cursor-pointer">
  </div>

  <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Ñ–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É -->
  <div class="md:w-1/2">
    <h1 class="text-3xl font-bold text-primary mb-2">{{ product.title }}</h1>
    <p class="text-gray-400 mb-4">{{ product.description }}</p>

    <form action="{% url 'store:add_to_cart' product.id %}" method="post" class="flex gap-3 mb-6">
      {% csrf_token %}
      <input type="number" name="quantity" value="1" min="1" class="w-20 p-2 rounded bg-secondary text-gray-200">
      <button type="submit" class="bg-primary text-white px-6 py-3 rounded-xl hover:bg-teal-500 transition">
        –î–æ–±–∞–≤–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω—É
      </button>
    </form>
  </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ -->
<div id="image-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center hidden z-50">
  <span id="close-modal" class="absolute top-5 right-5 text-white text-3xl cursor-pointer">&times;</span>
  <img id="modal-img" src="#" class="max-w-[90%] max-h-[90%] rounded-lg shadow-lg">
</div>

<!-- –û—Ç–∑—ã–≤—ã -->
<h2 class="text-2xl font-semibold text-primary mt-12 mb-4">–û—Ç–∑—ã–≤—ã</h2>

{% if user.is_authenticated %}
<form action="{% url 'store:add_review' product.id %}" method="post" enctype="multipart/form-data" class="space-y-4 mb-6">
  {% csrf_token %}

  <!-- –†–µ–π—Ç–∏–Ω–≥ -->
  <div class="flex gap-1 flex-row-reverse justify-end">
    {% for i in "54321" %}
      <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" class="hidden peer" />
      <label for="star{{ i }}" class="text-3xl cursor-pointer text-gray-500 peer-checked:text-yellow-400 hover:text-yellow-400 transition">‚òÖ</label>
    {% endfor %}
  </div>

  <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π -->
  {{ form.text }}

  <!-- –§–æ—Ç–æ -->
  <div class="flex items-center gap-2">
    <input type="file" id="review-image" name="image" class="hidden" accept="image/*">
    <label for="review-image" class="flex items-center px-3 py-2 bg-blue-600 text-white rounded-lg cursor-pointer hover:bg-blue-700 transition text-sm">
      üì∑ –í—ã–±—Ä–∞—Ç—å —Ñ–æ—Ç–æ
    </label>
    <span id="review-filename" class="text-gray-300 text-sm"></span>
  </div>

  <!-- –ü—Ä–µ–≤—å—é –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
  <img id="review-preview" src="#" class="mt-2 w-48 h-48 object-cover rounded-lg border border-gray-700 hidden">

  <!-- –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
  <button type="submit" class="flex items-center bg-gradient-to-r from-blue-500 to-blue-700 hover:from-blue-600 hover:to-blue-800 text-white px-5 py-2 rounded-full shadow-lg transition transform hover:scale-105">
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤
  </button>
</form>
{% else %}
<p class="text-gray-400 mb-4">–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å, —á—Ç–æ–±—ã –æ—Å—Ç–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤.</p>
{% endif %}

<!-- –°–ø–∏—Å–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ -->
{% if product.reviews.exists %}
  {% for review in product.reviews.all %}
    <div class="bg-accent/70 p-4 rounded-xl mb-3">
      <div class="flex justify-between items-center mb-2">
        <span class="font-semibold text-primary">{{ review.user.username }}</span>
        <div class="flex items-center gap-1">
          {% for i in "12345" %}
            {% if forloop.counter <= review.rating %}
              <span class="text-yellow-400 text-xl">‚òÖ</span>
            {% else %}
              <span class="text-gray-600 text-xl">‚òÖ</span>
            {% endif %}
          {% endfor %}
        </div>
      </div>
      <p class="text-gray-300">{{ review.text }}</p>
      {% if review.image %}
        <img src="{{ review.image.url }}" alt="–§–æ—Ç–æ –æ—Ç–∑—ã–≤–∞" class="mt-3 w-48 h-48 object-cover rounded-lg border border-gray-700">
      {% endif %}
      <p class="text-sm text-gray-500 mt-1">{{ review.created_at|date:"d.m.Y H:i" }}</p>
    </div>
  {% endfor %}
{% else %}
<p class="text-gray-500">–ü–æ–∫–∞ –Ω–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
{% endif %}

<script>
  // –ü—Ä–µ–≤—å—é —Ñ–æ—Ç–æ –æ—Ç–∑—ã–≤–∞
  const input = document.getElementById('review-image');
  const filename = document.getElementById('review-filename');
  const preview = document.getElementById('review-preview');

  input.addEventListener('change', () => {
    if(input.files.length > 0){
      const file = input.files[0];
      filename.textContent = file.name;
      const reader = new FileReader();
      reader.onload = e => { preview.src = e.target.result; preview.classList.remove('hidden'); }
      reader.readAsDataURL(file);
    } else {
      filename.textContent = '';
      preview.src = '#';
      preview.classList.add('hidden');
    }
  });

  // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Ñ–æ—Ç–æ —Ç–æ–≤–∞—Ä–∞
  const productImg = document.getElementById('product-image');
  const modal = document.getElementById('image-modal');
  const modalImg = document.getElementById('modal-img');
  const closeModal = document.getElementById('close-modal');

  productImg.addEventListener('click', () => {
      modalImg.src = productImg.src;
      modal.classList.remove('hidden');
  });

  closeModal.addEventListener('click', () => {
      modal.classList.add('hidden');
  });

  modal.addEventListener('click', (e) => {
      if (e.target === modal) {
          modal.classList.add('hidden');
      }
  });
</script>
{% endblock %}
